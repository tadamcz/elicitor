<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Elicit probability distributions from quantiles</title>
    <link rel="stylesheet" href= {{url_for('static', filename='styles.css') }}>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
{% from "_formhelpers.html" import render_field, render_field_nolabel, render_checkbox %}

<div class="flexbox">
<form method="POST" id="dataInputForm">
    <div style="margin-bottom: 1em">
        {{render_field(form.family,onchange="display_metalog_options()") }}
        {{render_field(form.nb_pairs,onchange="display_nb_pairs()")}}
    </div>

    {% for pair in form.pairs %}
    <div id = {{'pair' ~ loop.index}}>
        Pair {{loop.index}} {{render_field_nolabel(pair)}}
    </div>
    {% endfor %}

    {{ render_checkbox(form.plot_custom_domain_bool, onchange="display_conditional_fields('plot_custom_domain_bool','plot_custom_domain_l_r')")}}
    <div id="plot_custom_domain_l_r">
        {{ render_field(form.plot_custom_domain_left)}}
        {{ render_field(form.plot_custom_domain_right)}}
    </div>

    <div id = 'metalog_options'>
        {{render_checkbox(form.metalog_boundedness, onchange="display_conditional_fields('metalog_boundedness','metalog_bounds')")}}
        <div id="metalog_bounds">
            You may specify both bounds, or just one bound for a semi-bounded distribution.
            {{render_field(form.metalog_lower_bound)}}
            {{render_field(form.metalog_upper_bound)}}
        </div>


        <div>
        {{render_checkbox(form.metalog_allow_numerical)}}
            <div class = 'tooltip'>
                More info.
                <div class="tooltiptext">If there is no valid metalog for your inputs, this checkbox will allow the application to attempt to find the metalog
                that minimizes the sum of square differences between the metalog CDF and your inputs. This is slower. </div>
            </div>
        </div>
    </div>


    <div><input type="submit"> </div>
    <div id="example"><a href="javascript:display_example()">Click here to see an example</a></div>
</form>

<script>
function display_example(){
    document.getElementById("nb_pairs").value = 3
    document.getElementById("family").value = 'metalog'

    document.getElementById("plot_custom_domain_bool").checked = false
    display_conditional_fields('plot_custom_domain_bool','plot_custom_domain_l_r')

    document.getElementById("metalog_boundedness").checked = false
    display_conditional_fields('metalog_boundedness','metalog_bounds')

    document.getElementById("metalog_allow_numerical").checked = true

    document.getElementById("pairs-0-P").value = 0.15
    document.getElementById("pairs-0-Q").value = -20

    document.getElementById("pairs-1-P").value = .5
    document.getElementById("pairs-1-Q").value = -1

    document.getElementById("pairs-2-P").value = .85
    document.getElementById("pairs-2-Q").value = 50

    document.getElementById("dataInputForm").submit()

}
function display_nb_pairs() {
    const nb_pairs = document.getElementById("nb_pairs").value;
    const max_pairs = 10;
    let i;
    for (i = 1; i <= max_pairs; i++) {
        if (i <= nb_pairs) {
            document.getElementById("pair" + i).style.display = "block"
        } else {
            document.getElementById("pair" + i).style.display = "none"
        }
    }
}
display_nb_pairs()

function display_conditional_fields(checkboxdiv,fielddiv) {
    const checked = document.getElementById(checkboxdiv).checked
    if (checked) {
        document.getElementById(fielddiv).style.display = 'block'
    }
    else {
        document.getElementById(fielddiv).style.display = 'none'
    }
}

const conditionalFields = [
    {'checkbox':'metalog_boundedness','field':'metalog_bounds'},
    {'checkbox':'plot_custom_domain_bool','field':'plot_custom_domain_l_r'}
]
for (const conditionalField of conditionalFields) {
    display_conditional_fields(conditionalField.checkbox,conditionalField.field)
}

function display_metalog_options() {
    const family = document.getElementById("family").value;
    if (family == 'metalog') {
        document.getElementById('metalog_options').style.display = 'block'
        const nb_pairs = document.getElementById("nb_pairs").value
        if (nb_pairs < 3) {
            document.getElementById('nb_pairs').value = 3
            display_nb_pairs()
        }

    }
    else {
        document.getElementById('metalog_options').style.display = 'none'
    }
}
display_metalog_options()
</script>

<div id="results">
    {% if distribution %}
        {%for i in distribution.description%}
            <div>{{i}}</div>
        {%endfor%}

        {%for i in distribution.errors%}
            <div class="errors">{{i}}</div> <a href="javascript:window.history.back()">Go back.</a>
        {%endfor%}
    {% endif %}

    {% if plot %}
        <div>{{plot|safe}}</div>
    {% endif %}
    <!--plot.js needs to be after the plot, so that the JSONs we pass to plot.js are defined-->
    <script src={{url_for('static', filename="plot.js")}}></script>
</div>

{% if samples %}
<div style="max-width: 8em">
    Random samples:
    <pre>{{samples}}</pre>
</div>
{% endif %}
</div>




<br><div>
    By <a href='https://tadamcz.github.io/'>Tom Adamczewski</a>.
    Code <a href='https://github.com/tadamcz/elicitor'>on GitHub</a>.
    Got feedback? I'd love to hear it: <a href="mailto:tmkadamcz@gmail.com">tmkadamcz@gmail.com</a>
</div>

</body>
</html>